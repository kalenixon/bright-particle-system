const INITTHRESH=70,PSYCHWAITTIME=8e3,MOTION_LINE=1,MOTION_REV=2;let app={pixelSize:4,nodeDim:15,numNodes:3,nodeCollideThresh:35,drawSquare:!0,noiseScale:.1,thresh:0,useShader:!1,motion:MOTION_LINE,ns:.01},saved=[],nodes=[];function setup(){createCanvas(640,480),capture=createCapture(VIDEO),capture.hide(),app.thresh=INITTHRESH,colorMode(HSB,100);for(let e=0;e<app.numNodes;e++){let t=parseInt(random(10))%2==0?app.pixelSize:-app.pixelSize;t+=parseInt(random(0,2));let o=100/app.numNodes,i=color(parseInt(o*(e+1)),50,75);nodes[e]=new PixNode(app.nodeDim,random(width),random(height),2*app.pixelSize,i)}}function draw(){let e=app.ns;saved=[],background(255),colorMode(RGB,255),push(),scale(-1,1),image(capture.get(),-width,0),pop(),capture.loadPixels();for(let t=0;t<capture.width;t+=app.pixelSize)for(let o=0;o<capture.height;o+=app.pixelSize){let i=getLocColor(t,o);if(brightness(i)>app.thresh){{saved[t]||(saved[t]=[]),saved[t][o]=new PsychPix(width-t-1,o);let e=saved[t][o].getNode();if(!e||null==e){let e=height/nodes.length,i=null;for(let t=0;t<nodes.length;t++)if(o>=e*t&&o<e*(t+1)){i=t;break}saved[t][o].setNode(nodes[i])}}saved[t][o].setColor(i,e)}else saved[t]&&null!=saved[t][o]&&saved[t][o].hide()}for(let e=0;e<capture.width;e+=app.pixelSize)for(let t=0;t<capture.height;t+=app.pixelSize)saved[e]&&saved[e][t]&&saved[e][t].display();for(let e=0;e<nodes.length;e++)nodes[e].draw(),nodes[e].move();for(let e=0;e<nodes.length;e++)for(let t=0;t<nodes.length;t++)e!=t&&!nodes[e].collision&&!nodes[t].collision&&abs(nodes[e].location.x-nodes[t].location.x)<app.nodeCollideThresh&&abs(nodes[e].location.y-nodes[t].location.y)<app.nodeCollideThresh&&nodes[e].collide(nodes[t])}class PixNode{constructor(e,t,o,i,s){this.location=createVector(t,o),this.velocity=createVector(i,i),this.dim=e,this.speed=i,this.color=s,this.collision=!1,this.angle=0,this.angleDir=1}move(){app.motion==MOTION_LINE?(this.location.add(this.velocity),this.location.x>=width&&(this.location.x=width-1,this.velocity.x=-this.velocity.x-parseInt(random(-2,2))),this.location.x<=0&&(this.location.x=0,this.velocity.x=abs(this.velocity.x)+parseInt(random(-2,2))),this.location.y>=height&&(this.location.y=height-1,this.velocity.y=-this.velocity.y-parseInt(random(-2,2))),this.location.y<=0&&(this.location.y=0,this.velocity.y=abs(this.velocity.y)+parseInt(random(-2,2)))):app.motion==MOTION_REV&&(push(),translate(this.location.x,this.location.y),this.location.rotate(this.angle),0==this.angleDir?(this.angle-=.001,this.angle<=0&&(this.angleDir=1,this.angle=0)):(this.angle+=.001,this.angle>=1&&(this.angleDir=0,this.angle=1)),pop())}collide(e){if(app.motion==MOTION_LINE){let t=this,o=createVector(this.velocity.x,this.velocity.y);this.velocity.set(e.velocity.x,e.velocity.y),e.velocity.set(o.x,o.y),e.collision=!0,this.collision=!0,console.log("COLLISION!"),setTimeout(function(){e.collision=!1,t.collision=!1},100)}}draw(){fill(this.color),noStroke(),ellipse(this.location.x,this.location.y,this.dim,this.dim)}}class PsychPix{constructor(e,t){this.location=createVector(e,t),this.velocity=createVector(0,0),this.add=!0,this.amt=10,this.sum=0,this.node=null,this.color=null}getNode(){return this.node}setNode(e){this.node=e}move(){this.velocity=createVector(this.amt,this.amt),this.add?(this.location.add(this.velocity),this.sum+=this.amt):(this.location.sub(this.velocity),this.sum-=this.amt),this.sum>100&&this.add?this.add=!1:this.sum<=0&&!this.add&&(this.add=!0)}setColor(e,t){app.useShader&&(e=getRGBShader(e,this.location.x,this.location.y,t)),this.color=e}display(){stroke(this.color),strokeWeight(app.pixelSize),line(this.node.location.x,this.node.location.y,this.location.x,this.location.y)}hide(){}}function keyPressed(){for(let e=0;e<nodes.length;e++)81==keyCode?(nodes[e].velocity.x*=2,nodes[e].velocity.y*=2):87==keyCode?(nodes[e].velocity.x=parseInt(nodes[e].velocity.x/2),nodes[e].velocity.y=parseInt(nodes[e].velocity.y/2),nodes[e].velocity.x<=0&&(nodes[e].velocity.x=1),nodes[e].velocity.y<=0&&(nodes[e].velocity.y=1)):90==keyCode?app.useShader=!app.useShader:88==keyCode?app.motion==MOTION_LINE?app.motion=MOTION_REV:app.motion==MOTION_REV&&(app.motion=MOTION_LINE):65==keyCode&&(app.ns=random(0,1)/100)}function drawPixel(e,t,o,i){noStroke(),t?square(o,i,e):ellipse(o,i,e,e)}function getLocColor(e,t){let o=4*(e+t*capture.width),i=capture.pixels[o],s=capture.pixels[o+1],l=capture.pixels[o+2];return color(i,s,l)}function getShaderColor(e,t,o,i){let s=hue(e),l=saturation(e),n=brightness(e),a=noise((s+t)*i,(s+o)*i),h=noise((l+t)*i,(l+o)*i),d=noise((n+t)*i,(n+o)*i);return e=color(s*a,l*h,n*d*2)}function getRGBShader(e,t,o,i){let s=red(e),l=green(e),n=blue(e);if(i){let a=noise((s+t)*i,(s+o)*i),h=noise((l+t)*i,(l+o)*i),d=noise((n+t)*i,(n+o)*i);e=color(s*a,l*h,n*d),colorMode(HSB,100),e=color(hue(e),saturation(e),2*brightness(e)),colorMode(RGB,255)}return e}